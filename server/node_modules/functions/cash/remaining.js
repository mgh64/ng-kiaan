//
//
// by : mostafa
"use strict";

const mongoose = require('mongoose');
const db = require('db');
// const encrypt = require('encrypt');
// const date_to_persian = require('functions/date_to_persian');

module.exports = function(cb) {

  var unwind = {
    $unwind: '$items'
  };
  var match = {
    $match: {
      $or: [{
        "items.type": "cash"
      }, {
        "items.status": "pn"
      }]
    }
  };
  var group = {
    $group: {
      _id: null,
      // _id: {
      //   type: "$items.type",
      //   status: "$items.status"
      // },
      sum: {
        $sum: '$items.price'
      }
    }
  };

  var agg = [];

  agg.push(unwind);
  agg.push(match);
  agg.push(group);

  db.operations.aggregate(
    agg
  ).exec(function(err, result) {
    if (err) console.log(err);
    if (result) {
      return cb(null, result[0].sum);
    }
  });

}
